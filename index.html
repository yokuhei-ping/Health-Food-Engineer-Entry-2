<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>保健食品初級工程師｜歷屆試題線上練習（含星星熟悉度）</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>
    <noscript>本頁需要啟用 JavaScript 才能使用。</noscript>

    <!-- 必要函式庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

   <script type="text/babel" data-presets="env,react">
  const { useState, useEffect, useMemo, useRef } = React;

  const LS_KEY  = "hf-beginner-exam-app-v1";
  const LS_STAR = "hf-beginner-exam-stars-v1";
  const LS_RUN  = "hf-beginner-exam-run-v1";

  const serialize = (d)=>JSON.stringify(d);
  const deserialize = (s)=> (s?JSON.parse(s):null);
  const deBOM = (s)=> (typeof s==="string"? s.replace(/^\uFEFF/, ""): s);

  const normalizeKeys=(raw)=>{
    const out={};
    Object.entries(raw||{}).forEach(([k,v])=>{
      const nk = deBOM(String(k)).trim();
      out[nk]=v;
    });
    return out;
  };
  const pick=(obj,keys)=>{
    for(const k of keys){ if(obj[k]!=null && obj[k]!=="" ) return obj[k]; }
    return undefined;
  };
  const shuffle=(arr)=>{
    const a=[...arr];
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  };
  const fmtTime=(s)=>{
    const mm = Math.floor(s/60).toString().padStart(2,"0");
    const ss = Math.floor(s%60).toString().padStart(2,"0");
    return `${mm}:${ss}`;
  };

  // 轉換 CSV 列為題目物件
  const rowToQA=(row)=>{
    const r=normalizeKeys(row);
    const year=(pick(r,["year","年度","年份"])??"").toString().trim();
    const subject=(pick(r,["subject","科目"])??"").toString().trim();
    const question_no=(pick(r,["question_no","題號","題目編號","no","id"])??"").toString().trim();
    const question=(pick(r,["question","題目","stem"])??"").toString().trim();
    const option_A=(pick(r,["option_A","A","選項A"])??"").toString();
    const option_B=(pick(r,["option_B","B","選項B"])??"").toString();
    const option_C=(pick(r,["option_C","C","選項C"])??"").toString();
    const option_D=(pick(r,["option_D","D","選項D"])??"").toString();
    const correct_answers=(pick(r,["correct_answers","正確答案","answer"])??"").toString().replace(/\s/g,"");
    const notes=(pick(r,["notes","備註"])??"").toString();
    const date=(pick(r,["date","日期"])??"").toString();
    const session=(pick(r,["session","場次"])??"").toString().trim();
    const salt=(date || session || (question? question.slice(0,20).replace(/\s+/g,""):""));
    const id=`${year}-${salt}-${subject}-${question_no}`;
    const options=["A","B","C","D"].map(k=>({key:k, text:(k==="A"?option_A:k==="B"?option_B:k==="C"?option_C:option_D).trim()}));
    return { id,year,date,subject,question_no,question,option_A,option_B,option_C,option_D,options,correct_answers,notes };
  };

  // gh:owner/repo@ref:path → raw URL
  const resolveGhUrl=(s)=>{
    if(!s) return s;
    if(s.startsWith("gh:")){
      const body=s.slice(3);
      const [repoPart, path] = body.split(":");
      const [ownerRepo, ref] = repoPart.split("@");
      const [owner, repo] = ownerRepo.split("/");
      return `https://raw.githubusercontent.com/${owner}/${repo}/${ref}/${encodeURI(path)}`;
    }
    return s;
  };

  const StarBar=({value=0,size=18})=>{
    const full=Math.max(0,Math.min(5,Number(value)||0));
    return (
      <div className="inline-flex items-center" title={`熟悉度：${full} 顆星`}>
        {Array.from({length:5}).map((_,i)=>(
          <svg key={i} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width={size} height={size}
               className={i<full?"fill-yellow-400 text-yellow-400":"fill-none text-gray-300"}
               stroke="currentColor" strokeWidth="2">
            <path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
          </svg>
        ))}
      </div>
    );
  };

  function App(){
    const [bank,setBank]=useState([]);
    const [subject,setSubject]=useState("全部科目");
    const [year,setYear]=useState("全部年度");
    const [mode,setMode]=useState("practice"); // practice | exam
    const [limit,setLimit]=useState(40);
    const [page,setPage]=useState(0);
    const [answers,setAnswers]=useState({});
    const [started,setStarted]=useState(false);
    const [seed,setSeed]=useState(0);
    const [seconds,setSeconds]=useState(0);
    const timerRef=useRef(null);

    // 凍結考卷
    const [frozenPaperIds,setFrozenPaperIds]=useState(null);

    // 星星
    const [stars,setStars]=useState({});
    const [maxStarFilter,setMaxStarFilter]=useState(null); // null=全部；0..5 = ≤N

    // 題庫載入（本機 or URL）
    const [csvUrl,setCsvUrl]=useState("gh:yokuhei-ping/Health-Food-Engineer-Entry/blob/e3bc24efb2d16072a5083b886fe8248d43cf7bf9/Question_All_0826.csv.xlsx");
    const bootLoadedRef=useRef(false);

    // ---- 初始化 / 持久化 ----
    useEffect(()=>{
      const saved=deserialize(localStorage.getItem(LS_KEY));
      if(saved){
        setBank(saved.bank||[]);
        setSubject(saved.subject||"全部科目");
        setYear(saved.year||"全部年度");
        setMode(saved.mode||"practice");
      }
      const s=deserialize(localStorage.getItem(LS_STAR)); if(s) setStars(s);
      const run=deserialize(localStorage.getItem(LS_RUN));
      if(run){
        setStarted(!!run.started);
        setAnswers(run.answers||{});
        setPage(run.page||0);
        setFrozenPaperIds(run.frozenPaperIds||null);
        setSeed(run.seed||0);
        setLimit(run.limit||40);
        setMode(run.mode||"practice");
        setSubject(run.subject||"全部科目");
        setYear(run.year||"全部年度");
        if(run.maxStarFilter!=null) setMaxStarFilter(run.maxStarFilter);
      }
    },[]);

    // 如果一開始 bank 為空，嘗試用預設 URL 載入一次
    useEffect(()=>{
      if(bootLoadedRef.current) return;
      if(bank.length===0 && csvUrl){
        bootLoadedRef.current=true;
        loadFromUrl(csvUrl);
      }
    },[bank.length,csvUrl]);

    useEffect(()=>{ localStorage.setItem(LS_KEY, serialize({bank,subject,year,mode})); },[bank,subject,year,mode]);
    useEffect(()=>{ localStorage.setItem(LS_STAR, serialize(stars)); },[stars]);
    useEffect(()=>{ localStorage.setItem(LS_RUN, serialize({started,answers,page,frozenPaperIds,seed,limit,mode,subject,year,maxStarFilter})); },
      [started,answers,page,frozenPaperIds,seed,limit,mode,subject,year,maxStarFilter]);

    // ---- 導出年度/科目清單 ----
    const subjectList=useMemo(()=>{
      const s=new Set(bank.map(q=>q.subject).filter(Boolean));
      return ["全部科目",...Array.from(s)];
    },[bank]);
    const yearList=useMemo(()=>{
      const s=new Set(bank.map(q=>String(q.year)).filter(Boolean));
      return ["全部年度",...Array.from(s).sort((a,b)=>b.localeCompare(a))];
    },[bank]);

    // ---- 篩選 & 出卷（支援凍結）----
    const filtered=useMemo(()=> bank.filter(q=>{
      const okS = subject==="全部科目" || q.subject===subject;
      const okY = year==="全部年度"   || String(q.year)===year;
      const st  = Number(stars[q.id]||0);
      const okStar = (maxStarFilter==null) || st<=maxStarFilter;
      return okS && okY && okStar;
    }),[bank,subject,year,stars,maxStarFilter]);

    const paper=useMemo(()=>{
      if(started && Array.isArray(frozenPaperIds) && frozenPaperIds.length){
        const byId=new Map(bank.map(q=>[q.id,q]));
        return frozenPaperIds.map((id,i)=>byId.get(id)).filter(Boolean).map((q,i)=>({...q,order:i+1}));
      }
      const base=shuffle(filtered.slice());
      return base.slice(0,Math.min(limit,base.length)).map((q,i)=>({...q,order:i+1}));
    },[bank,filtered,limit,started,frozenPaperIds,seed]);

    // ---- 計時（模擬測驗）----
    useEffect(()=>{
      if(!started || mode!=="exam") return;
      timerRef.current=setInterval(()=>setSeconds(s=>s+1),1000);
      return ()=>clearInterval(timerRef.current);
    },[started,mode]);

    // ---- 作答 & 星星規則 ----
    const current=paper[page];
    const choose=(qid,key)=>setAnswers(prev=>({...prev,[qid]:key}));
    const correctSetOf=(q)=> (q.correct_answers||"").split(",").map(x=>x.trim()).filter(Boolean);
    const isCorrect=(q,user)=> user ? correctSetOf(q).includes(user) : false;

    useEffect(()=>{
      if(!current) return;
      const picked=answers[current.id]; if(!picked) return;
      const correct=isCorrect(current,picked);
      setStars(prev=>{
        const cur=Number(prev[current.id]||0);
        const next=correct? Math.min(5,cur+1): 0;
        if(next===cur) return prev;
        return {...prev,[current.id]:next};
      });
    },[current,answers]);

    // ---- 統計 ----
    const score=useMemo(()=>{
      let right=0; paper.forEach(q=>{ if(isCorrect(q,answers[q.id])) right++; });
      return {right,total:paper.length};
    },[paper,answers]);
    const answeredCount=useMemo(()=>{
      const set=new Set(paper.map(q=>q.id));
      let n=0; for(const [qid,v] of Object.entries(answers)){ if(set.has(qid)&&v) n++; }
      return n;
    },[paper,answers]);
    const progressPct=useMemo(()=> paper.length? Math.round(answeredCount/paper.length*100):0,[answeredCount,paper.length]);

    // ---- 出卷/交卷 ----
    const start=()=>{
      const ids=shuffle(filtered.slice()).slice(0,Math.min(limit,filtered.length)).map(q=>q.id);
      setFrozenPaperIds(ids);
      setAnswers({}); setPage(0); setSeed(s=>s+1); setSeconds(0); setStarted(true);
    };
    const stop=()=>{ setStarted(false); if(timerRef.current) clearInterval(timerRef.current); };

    // ---- 匯出錯題本 CSV ----
    const exportWrongCsv=()=>{
      // 以目前作答紀錄為準（本次考卷或歷次留存的 answers）
      const byId=new Map(bank.map(q=>[q.id,q]));
      const rows=[];
      for(const [qid,ua] of Object.entries(answers||{})){
        const q=byId.get(qid);
        if(!q || !ua) continue;
        const ok=correctSetOf(q);
        const isRight=ok.includes(ua);
        if(isRight) continue; // 只收錯題
        rows.push({
          year: q.year, subject: q.subject, question_no: q.question_no,
          question: q.question, option_A: q.option_A, option_B: q.option_B,
          option_C: q.option_C, option_D: q.option_D,
          correct_answers: q.correct_answers, user_answer: ua,
          notes: q.notes ?? ""
        });
      }
      if(rows.length===0){ alert("目前沒有錯題可以匯出～ (๑•̀ㅂ•́)و✧"); return; }
      const csv = Papa.unparse(rows);
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8" });
      saveAs(blob, "wrong_notes.csv");
    };

    // ---- 清空題庫（僅清 bank）----
    const clearBank=()=>{
      if(!confirm("確定清空題庫？（僅刪除題庫內容，其他狀態保留）")) return;
      setBank([]);
      // 額外把凍結考卷解除，避免殘留引用
      setFrozenPaperIds(null);
      setStarted(false);
      setPage(0);
    };

    // ---- 載入 CSV ----
    const loadFromFile=(file)=>{
      if(!file) return;
      Papa.parse(file, {
        header:true, skipEmptyLines:true, encoding:"UTF-8",
        complete:(res)=>{
          const rows=res.data||[];
          const items=rows.map(rowToQA).filter(x=>x.id && x.question);
          setBank(items);
        },
        error:(e)=>alert("匯入失敗："+e.message)
      });
    };
    async function loadFromUrl(urlStr){
      try{
        const url=resolveGhUrl((urlStr||csvUrl).trim());
        const resp=await fetch(url);
        const text=await resp.text();
        Papa.parse(text,{
          header:true, skipEmptyLines:true,
          complete:(res)=>{
            const rows=res.data||[];
            const items=rows.map(rowToQA).filter(x=>x.id && x.question);
            setBank(items);
          },
          error:(e)=>alert("解析失敗："+e.message)
        });
      }catch(err){
        alert("下載失敗："+(err?.message||err));
      }
    }

    // ---- UI ----
    const correctColor=(picked,isRight)=> {
      return (mode==="practice")
        ? (picked ? (isRight ? "bg-green-50 border-green-400" : "bg-red-50 border-red-400") : "")
        : (picked ? "bg-blue-50 border-blue-400" : "");
    };

    return (
      <div className="p-6">
        <h1 className="font-bold text-xl mb-3">保健食品初級工程師｜歷屆試題線上練習（含星星熟悉度）</h1>

        {/* 若題庫為空，顯示載入控件 */}
        {bank.length===0 && (
          <div className="mb-4 p-4 bg-amber-50 border border-amber-300 rounded">
            <div className="mb-2">目前題庫為空，請以以下任一方式載入：</div>
            <div className="flex flex-col sm:flex-row gap-2 items-start">
              <label className="text-sm">
                本機 CSV：
                <input type="file" accept=".csv" className="ml-2" onChange={e=>loadFromFile(e.target.files[0])}/>
              </label>
              <div className="flex gap-2 items-center">
                <input className="border rounded px-2 py-1 w-96" placeholder="貼上 CSV 連結（可用 gh: 短網址）"
                       value={csvUrl} onChange={e=>setCsvUrl(e.target.value)} />
                <button className="border rounded px-3 py-1" onClick={()=>loadFromUrl(csvUrl)}>從連結載入</button>
              </div>
            </div>
          </div>
        )}

        {/* 控制列 */}
        <div className="flex flex-wrap items-center gap-3 mb-4">
          {/* 模式 */}
          <div className="inline-flex rounded-lg overflow-hidden border">
            <button className={`px-3 py-1 ${mode==='practice'?'bg-blue-600 text-white':'bg-white'}`} onClick={()=>setMode('practice')}>練習模式</button>
            <button className={`px-3 py-1 ${mode==='exam'?'bg-blue-600 text-white':'bg-white'}`} onClick={()=>setMode('exam')}>模擬測驗</button>
          </div>

          {/* 年度/科目 */}
          <select className="border rounded px-2 py-1" value={year} onChange={e=>setYear(e.target.value)}>
            {yearList.map(y=><option key={y} value={y}>{y}</option>)}
          </select>
          <select className="border rounded px-2 py-1" value={subject} onChange={e=>setSubject(e.target.value)}>
            {subjectList.map(s=><option key={s} value={s}>{s}</option>)}
          </select>

          {/* 題數上限 */}
          <label className="text-sm text-gray-600">出題數：
            <input type="number" min="1" className="ml-1 w-20 border rounded px-2 py-1"
                   value={limit} onChange={e=>setLimit(Number(e.target.value)||1)} />
          </label>

          {/* 星星篩選 */}
          <div className="flex items-center gap-1">
            <span className="text-sm">星星≤</span>
            {[-1,0,1,2,3,4,5].map(v=>(
              <button key={v}
                className={`text-sm border rounded px-2 py-1 ${maxStarFilter===(v<0?null:v)?'bg-amber-200':'bg-white'}`}
                onClick={()=>setMaxStarFilter(v<0?null:v)}>
                {v<0?'全部':v}
              </button>
            ))}
          </div>

          {/* 功能：匯出錯題本、清空題庫 */}
          <button className="border rounded px-3 py-1" onClick={exportWrongCsv}>匯出錯題本 CSV</button>
          <button className="border rounded px-3 py-1" onClick={clearBank}>清空題庫</button>

          {/* 開始/結束 */}
          <div className="ml-auto">
            {!started
              ? <button className="border px-3 py-1 rounded bg-green-600 text-white" onClick={start}>開始作答</button>
              : <button className="border px-3 py-1 rounded bg-red-600 text-white" onClick={stop}>結束/交卷</button>}
          </div>
        </div>

        {/* 進度列 */}
        {started && (
          <div className="mb-3">
            <div className="flex items-center justify-between text-sm mb-1">
              <div>作答進度：{answeredCount}/{paper.length} 題（{progressPct}%）</div>
              <div>目前統計：<span className="font-semibold">{score.right}</span>/<span>{score.total}</span> 題 正確</div>
              {mode==="exam" && <div className="font-mono">計時：{fmtTime(seconds)}</div>}
            </div>
            <div className="w-full h-2 bg-gray-200 rounded">
              <div className="h-2 bg-blue-500 rounded" style={{width:`${progressPct}%`}}/>
            </div>
          </div>
        )}

        {/* 題目 */}
        {started && paper.length>0 && (
          <div className="bg-white shadow rounded p-4">
            <div className="text-sm mb-2 flex items-center justify-between">
              <div>第 {page+1}/{paper.length} 題</div>
              <StarBar value={Number(stars[paper[page].id]||0)} />
            </div>

            <h2 className="mb-3">{paper[page].question}</h2>

            <ul className="mb-3">
              {paper[page].options.map(op=>{
                const picked=answers[paper[page].id]===op.key;
                const isRight=correctSetOf(paper[page]).includes(op.key);
                return (
                  <li key={op.key}>
                    <button
                      onClick={()=>choose(paper[page].id,op.key)}
                      className={`border block w-full text-left rounded px-3 py-2 mb-2 ${correctColor(picked,isRight)}`}>
                      <span className="font-mono mr-2">({op.key})</span>{op.text}
                    </button>
                  </li>
                );
              })}
            </ul>

            <div className="mt-2 flex gap-2">
              <button className="border rounded px-3 py-1" disabled={page===0} onClick={()=>setPage(p=>p-1)}>上一題</button>
              <button className="border rounded px-3 py-1" disabled={page>=paper.length-1} onClick={()=>setPage(p=>p+1)}>下一題</button>
            </div>

            {mode==="practice" && answers[paper[page].id] && (
              <div className="mt-3 border-t pt-3 text-sm">
                正確答案：<span className="font-bold text-green-700">{correctSetOf(paper[page]).join("、")||"（未提供）"}</span>
              </div>
            )}
          </div>
        )}

        {/* 題目清單快速跳轉 */}
        {started && paper.length>0 && (
          <div className="mt-4">
            <div className="text-sm text-gray-600 mb-2">題目清單（點擊可跳轉）：</div>
            <div className="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
              {paper.map((q,idx)=>{
                const picked=!!answers[q.id];
                const right=isCorrect(q,answers[q.id]);
                const color=picked?(right?"bg-green-50 border-green-400":"bg-red-50 border-red-400"):"bg-white";
                return (
                  <button key={q.id}
                          className={`border rounded px-2 py-1 text-sm flex items-center justify-between ${color}`}
                          onClick={()=>setPage(idx)} title={`第 ${idx+1} 題`}>
                    <span className="font-mono">#{idx+1}</span>
                    <StarBar value={Number(stars[q.id]||0)} size={14}/>
                  </button>
                );
              })}
            </div>
          </div>
        )}
      </div>
    );
  }

  const root = ReactDOM.createRoot(document.getElementById("root"));
  root.render(<App/>);
</script>


  </body>
</html>
