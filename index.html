<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>保健食品初級工程師｜歷屆試題線上練習（含星星熟悉度）</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>
    <noscript>本頁需要啟用 JavaScript 才能使用。</noscript>

    <!-- 必要函式庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo, useRef } = React;
      const PapaLib = window.Papa;
      const FileSaver = window.FileSaver || { saveAs: window.saveAs };

      const LS_KEY = "hf-beginner-exam-app-v1";
      const LS_STAR = "hf-beginner-exam-stars-v1";
      const LS_RUN  = "hf-beginner-exam-run-v1"; // ★ 作答狀態

      const serialize = (data) => JSON.stringify(data);
      const deserialize = (s) => (s ? JSON.parse(s) : null);
      const deBOM = (s) => (typeof s === "string" ? s.replace(/^\uFEFF/, "") : s);
      const normalizeKeys = (raw) => {
        const out = {};
        Object.entries(raw || {}).forEach(([k, v]) => {
          const nk = deBOM(String(k)).trim();
          out[nk] = v;
        });
        return out;
      };
      const pick = (obj, keys) => {
        for (const k of keys) {
          if (obj[k] != null && obj[k] !== "") return obj[k];
        }
        return undefined;
      };
      const shuffle = (arr) => {
        const copy = [...arr];
        for (let i = copy.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
      };
      const fmtTime = (s) => {
        const mm = Math.floor(s / 60).toString().padStart(2, "0");
        const ss = Math.floor(s % 60).toString().padStart(2, "0");
        return `${mm}:${ss}`;
      };

      // QA 資料轉換
      const rowToQA = (row) => {
        const r = normalizeKeys(row);
        const year = (pick(r, ["year","年度","年份"]) ?? "").toString().trim();
        const subject = (pick(r, ["subject","科目"]) ?? "").toString().trim();
        const question_no = (pick(r, ["question_no","題號","題目編號","no","id"]) ?? "").toString().trim();
        const question = (pick(r, ["question","題目","stem"]) ?? "").toString().trim();
        const option_A = (pick(r, ["option_A","A","選項A"]) ?? "").toString();
        const option_B = (pick(r, ["option_B","B","選項B"]) ?? "").toString();
        const option_C = (pick(r, ["option_C","C","選項C"]) ?? "").toString();
        const option_D = (pick(r, ["option_D","D","選項D"]) ?? "").toString();
        const correct_answers = (pick(r, ["correct_answers","正確答案","answer"]) ?? "").toString().replace(/\s/g,"");
        const notes = (pick(r, ["notes","備註"]) ?? "").toString();
        const date = (pick(r, ["date","日期"]) ?? "").toString();
        const session = (pick(r, ["session","場次"]) ?? "").toString().trim();
        const salt = (date || session || (question ? String(question).slice(0,20).replace(/\s+/g,""):""));
        const id = `${year}-${salt}-${subject}-${question_no}`;
        const opts = ["A","B","C","D"].map((k)=>({ key:k, text:(k==="A"?option_A:k==="B"?option_B:k==="C"?option_C:option_D).trim() }));
        return { id,year,date,subject,question_no,question,option_A,option_B,option_C,option_D,options:opts,correct_answers,notes };
      };

      // 星星顯示元件
      const StarBar = ({ value=0, size=18 }) => {
        const full = Math.max(0, Math.min(5, Number(value)||0));
        return (
          <div className="inline-flex items-center" title={`熟悉度：${full} 顆星`}>
            {Array.from({ length:5 }).map((_,i)=>(
              <svg key={i} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width={size} height={size}
                className={i<full ? "fill-yellow-400 text-yellow-400" : "fill-none text-gray-300"}
                stroke="currentColor" strokeWidth="2">
                <path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
              </svg>
            ))}
          </div>
        );
      };

      function App(){
        const [bank,setBank] = useState([]);
        const [subject,setSubject] = useState("全部科目");
        const [year,setYear] = useState("全部年度");
        const [mode,setMode] = useState("practice");
        const [limit,setLimit] = useState(40);
        const [page,setPage] = useState(0);
        const [answers,setAnswers] = useState({});
        const [started,setStarted] = useState(false);
        const [seed,setSeed] = useState(0);
        const [seconds,setSeconds] = useState(0);
        const timerRef = useRef(null);

        // ★ 凍結考卷 id 清單
        const [frozenPaperIds,setFrozenPaperIds] = useState(null);

        const [stars,setStars] = useState({});
        const [maxStarFilter,setMaxStarFilter] = useState(null);

        // 載入 localStorage
        useEffect(()=>{
          const saved = deserialize(localStorage.getItem(LS_KEY));
          if(saved){
            setBank(saved.bank||[]);
            setSubject(saved.subject||"全部科目");
            setYear(saved.year||"全部年度");
            setMode(saved.mode||"practice");
          }
          const s = deserialize(localStorage.getItem(LS_STAR));
          if(s) setStars(s);
          const run = deserialize(localStorage.getItem(LS_RUN));
          if(run){
            setStarted(!!run.started);
            setAnswers(run.answers||{});
            setPage(run.page||0);
            setFrozenPaperIds(run.frozenPaperIds||null);
            setSeed(run.seed||0);
            setLimit(run.limit||40);
            setMode(run.mode||"practice");
            setSubject(run.subject||"全部科目");
            setYear(run.year||"全部年度");
            if(run.maxStarFilter!=null) setMaxStarFilter(run.maxStarFilter);
          }
        },[]);

        // 儲存
        useEffect(()=>{
          localStorage.setItem(LS_KEY, serialize({bank,subject,year,mode}));
        },[bank,subject,year,mode]);
        useEffect(()=>{ localStorage.setItem(LS_STAR, serialize(stars)); },[stars]);
        useEffect(()=>{
          localStorage.setItem(LS_RUN, serialize({started,answers,page,frozenPaperIds,seed,limit,mode,subject,year,maxStarFilter}));
        },[started,answers,page,frozenPaperIds,seed,limit,mode,subject,year,maxStarFilter]);

        // 產生考卷 (凍結/未凍結)
        const filtered = useMemo(()=> bank.filter(q=>{
          const okS = subject==="全部科目" || q.subject===subject;
          const okY = year==="全部年度" || String(q.year)===year;
          const st = Number(stars[q.id]||0);
          const okStar = (maxStarFilter==null) || st<=maxStarFilter;
          return okS&&okY&&okStar;
        }),[bank,subject,year,stars,maxStarFilter]);

        const paper = useMemo(()=>{
          if(started && Array.isArray(frozenPaperIds) && frozenPaperIds.length){
            const byId = new Map(bank.map(q=>[q.id,q]));
            return frozenPaperIds.map((id,i)=>byId.get(id)).filter(Boolean).map((q,i)=>({...q,order:i+1}));
          }
          const base = shuffle(filtered.slice());
          return base.slice(0,Math.min(limit,base.length)).map((q,i)=>({...q,order:i+1}));
        },[bank,filtered,limit,started,frozenPaperIds,seed]);

        // timer
        useEffect(()=>{
          if(!started||mode!=="exam") return;
          timerRef.current=setInterval(()=>setSeconds(s=>s+1),1000);
          return ()=>clearInterval(timerRef.current);
        },[started,mode]);

        const start=()=>{
          const ids=shuffle(filtered.slice()).slice(0,Math.min(limit,filtered.length)).map(q=>q.id);
          setFrozenPaperIds(ids); setAnswers({}); setPage(0); setSeed(s=>s+1); setSeconds(0); setStarted(true);
        };
        const stop=()=>{ setStarted(false); if(timerRef.current) clearInterval(timerRef.current); };

        const current=paper[page];
        const choose=(qid,key)=>setAnswers(prev=>({...prev,[qid]:key}));
        const isCorrect=(q,user)=>{
          const ok=(q.correct_answers||"").split(",").map(x=>x.trim());
          return user?ok.includes(user):false;
        };

        // 答題後更新星星
        useEffect(()=>{
          if(!current) return;
          const picked=answers[current.id];
          if(!picked) return;
          const correct=isCorrect(current,picked);
          setStars(prev=>{
            const cur=Number(prev[current.id]||0);
            const next=correct?Math.min(5,cur+1):0;
            if(next===cur) return prev;
            return {...prev,[current.id]:next};
          });
        },[current,answers]);

        // 統計
        const score=useMemo(()=>{
          let right=0; paper.forEach(q=>{if(isCorrect(q,answers[q.id])) right+=1;});
          return {right,total:paper.length};
        },[paper,answers]);

        const answeredCount=useMemo(()=>{
          const set=new Set(paper.map(q=>q.id));
          let n=0; for(const [qid,v] of Object.entries(answers)){ if(set.has(qid)&&v) n++; }
          return n;
        },[paper,answers]);

        return (
          <div className="p-6">
            <h1 className="font-bold text-xl mb-2">保健食品初級工程師｜歷屆試題線上練習</h1>
            <div className="mb-4">
              <button className="border px-3 py-1 rounded" onClick={start}>開始作答</button>
              {started && <button className="border px-3 py-1 rounded ml-2" onClick={stop}>結束/交卷</button>}
            </div>

            {started && current && (
              <div className="bg-white shadow rounded p-4">
                <div className="text-sm mb-2">第 {page+1}/{paper.length} 題</div>
                <h2 className="mb-2">{current.question}</h2>
                <ul>
                  {current.options.map(op=>{
                    const picked=answers[current.id]===op.key;
                    const correctSet=(current.correct_answers||"").split(",").map(x=>x.trim());
                    const isRight=correctSet.includes(op.key);
                    return (
                      <li key={op.key}>
                        <button
                          onClick={()=>choose(current.id,op.key)}
                          className={
                            "border block w-full text-left rounded px-2 py-1 mb-1 " +
                            (picked && (mode==="practice") ? (isRight ? "bg-green-100" : "bg-red-100") : "")
                          }
                        >
                          ({op.key}) {op.text}
                        </button>
                      </li>
                    );
                  })}
                </ul>
                <div className="mt-2 flex gap-2">
                  <button disabled={page===0} onClick={()=>setPage(p=>p-1)}>上一題</button>
                  <button disabled={page>=paper.length-1} onClick={()=>setPage(p=>p+1)}>下一題</button>
                </div>
              </div>
            )}

            {started && (
              <div className="mt-4">
                <div>作答進度：{answeredCount}/{paper.length} 題</div>
                <div>目前統計：{score.right}/{score.total} 題 正確</div>
              </div>
            )}
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App/>);
    </script>
  </body>
</html>
